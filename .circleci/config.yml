version: 2

aliases:
  - &dockerImage
    docker:
      - image: node:12.14.0-alpine
  # fixes https://discuss.circleci.com/t/requesterror-x509-certificate-signed-by-unknown-authority-while-uploading-workspace/27908/3
  - &addCertificates
    run: apk add --no-cache ca-certificates

jobs:
  install:
    <<: *dockerImage
    steps:
      - *addCertificates
      - checkout
      - run:
          name: client install
          command: cd client && npm ci && cd -
      - run:
          name: server install
          command: cd server && npm ci && cd -
      - persist_to_workspace:
          root: .
          paths: '*'
  lint:
    <<: *dockerImage
    steps:
      - *addCertificates
      - attach_workspace:
          at: .
      - run:
          name: client lint
          command: cd client && npm run lint && cd -
      - run:
          name: server lint
          command: cd server && npm run lint && cd -
      - run:
          name: client build
          command: cd client && npm run build && cd -
  test:
    <<: *dockerImage
    steps:
      - *addCertificates
      - attach_workspace:
          at: .
      - run:
          name: client test
          command: cd client && npm run test && cd -
      - run:
          name: server test
          command: cd server && npm run test && cd -
  e2e:
    # https://docs.cypress.io/guides/guides/continuous-integration.html#Example-circle-yml-v2-config-file
    docker:
      - image: cypress/base:12.14.0
        environment:
          TERM: xterm
    steps:
      - *addCertificates
      - attach_workspace:
          at: .
      - checkout
      - restore_cache:
          keys:
            - v1-deps-{{ .Branch }}-{{ checksum "package.json" }}
            - v1-deps-{{ .Branch }}
            - v1-deps
      - run:
          name: e2e install
          command: cd client && npm ci && cd -
      - save_cache:
          key: v1-deps-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ~/.npm
            - ~/.cache
      - run:
          name: e2e test
          command: cd client && npm run e2e:ci && cd -

workflows:
  version: 2
  dev-worflow:
    jobs:
      - install
      - lint:
          requires:
            - install
      - test:
          requires:
            - install
      - e2e:
          requires:
            - install
